<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kcal - Calculadora de calorías</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
</head>
<body>
    <!-- Código para prevenir duplicación de elementos y resolver problemas de renderizado -->
    <div id="duplicate-prevention" style="display:none;"></div>
    <script>
    (function() {
        // 1. Código para limpiar cualquier elemento fantasma en el DOM
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length) {
                        mutation.addedNodes.forEach(function(node) {
                            // Comprobar nodos de texto sueltos
                            if (node.nodeType === 3 && node.parentNode === document.body) {
                                const text = node.textContent.trim();
                                if (text === 'Configurar Objetivos' || text.includes('✕') || text === '×') {
                                    node.parentNode.removeChild(node);
                                }
                            }
                            
                            // Comprobar elementos no deseados fuera de la estructura
                            if (node.nodeType === 1 && node.parentNode === document.body) {
                                // Si es un elemento h2 o button fuera de estructura
                                if ((node.tagName === 'H2' || node.tagName === 'BUTTON') && 
                                    !node.id && 
                                    !node.closest('.modal') && 
                                    !node.closest('.card') && 
                                    !node.closest('.header-actions')) {
                                    
                                    console.log('Eliminando elemento fuera de estructura:', node);
                                    node.parentNode.removeChild(node);
                                }
                            }
                        });
                    }
                });
            });
            
            // Observar cambios en el body
            observer.observe(document.body, { 
                childList: true, 
                subtree: true, 
                attributes: false, 
                characterData: true 
            });
        }
        
        // 2. Asegurar que solo un formulario esté visible a la vez
        document.addEventListener('DOMContentLoaded', function() {
            // Función para manejar el estado visual de la aplicación
            window.updateAppVisualState = function(state) {
                const calculatorCard = document.getElementById('calculator-card');
                const resultsCard = document.getElementById('results-card');
                const historyCard = document.getElementById('history-card');
                const trackingPanel = document.getElementById('tracking-panel');
                const foodTabs = document.getElementById('food-tabs');
                const goalModal = document.getElementById('goalModal');
                
                // Ocultar todo primero
                if (calculatorCard) calculatorCard.style.display = 'none';
                if (resultsCard) resultsCard.style.display = 'none';
                if (historyCard) historyCard.style.display = 'none';
                if (trackingPanel) trackingPanel.style.display = 'none';
                if (foodTabs) foodTabs.style.display = 'none';
                if (goalModal) goalModal.style.display = 'none';
                
                // Mostrar solo lo necesario según el estado
                switch(state) {
                    case 'calculator':
                        if (calculatorCard) calculatorCard.style.display = 'block';
                        break;
                    case 'results':
                        if (resultsCard) resultsCard.style.display = 'block';
                        break;
                    case 'tracking':
                        if (calculatorCard) calculatorCard.style.display = 'none';
                        if (resultsCard) resultsCard.style.display = 'none';
                        if (historyCard) historyCard.style.display = 'block';
                        if (trackingPanel) trackingPanel.style.display = 'block';
                        if (foodTabs) foodTabs.style.display = 'none';
                        break;
                    case 'goals':
                        if (goalModal) goalModal.style.display = 'block';
                        break;
                    default:
                        if (calculatorCard) calculatorCard.style.display = 'block';
                }
            };
            
            // NO inicializar con una vista específica aquí - dejar que loadData() decida
            // qué pantalla mostrar en base a datos guardados
            console.log("[INDEX] Iniciando sin pantalla fija, loadData() decidirá qué mostrar...");
            // La carga inicial se realizará en main.js
        });
    })();
    </script>

    <header class="app-header">
        <div class="container header-container">
            <div class="logo-container">
                <h1>
                    <span class="logo-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                            <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                            <line x1="6" y1="1" x2="6" y2="4"></line>
                            <line x1="10" y1="1" x2="10" y2="4"></line>
                            <line x1="14" y1="1" x2="14" y2="4"></line>
                        </svg>
                    </span>
                    Kcal
                </h1>
                <span class="app-subtitle">Nutrición inteligente</span>
            </div>
            <div class="header-actions">
                <button id="editGoalsButton" class="button button-secondary button-small">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Editar objetivos
                </button>
                <div id="theme-toggle" class="button button-icon button-tertiary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <div class="container">
            <!-- Formulario de cálculo de calorías -->
            <div class="card gradient-card" id="calculator-card">
                <div class="card-header">
                    <h2>Calcular Requerimiento Calórico</h2>
                    <span class="card-badge">Personalizado</span>
                </div>
                <form id="calculator-form" onsubmit="return false;">
                    <div class="form-section">
                        <h3>Datos personales básicos</h3>
                        <div class="form-group">
                            <label for="gender">Género</label>
                            <div class="select-wrapper">
                                <select id="gender" name="gender" required>
                                    <option value="male">Masculino</option>
                                    <option value="female">Femenino</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="age">Edad</label>
                            <input type="number" id="age" name="age" min="18" max="100" placeholder="Años" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weight">Peso</label>
                                <input type="number" id="weight" name="weight" min="40" max="200" step="0.1" placeholder="kg" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="height">Altura</label>
                                <input type="number" id="height" name="height" min="140" max="220" placeholder="cm" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Composición corporal</h3>
                        <div class="form-group">
                            <label for="bodyfat">% Grasa corporal</label>
                            <input type="number" id="bodyfat" name="bodyfat" min="3" max="50" step="0.1" placeholder="%" >
                            <small>Opcional pero recomendado para mayor precisión</small>
                        </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Actividad física y ocupación</h3>
                            <div class="form-group">
                                <label for="activity-level">Nivel de Actividad General</label>
                                <div class="select-wrapper">
                                    <select id="activity-level" name="activity" required>
                                        <option value="1.2">Sedentario (poco o nada de ejercicio)</option>
                                        <option value="1.375">Ligero (ejercicio 1-3 días/semana)</option>
                                        <option value="1.55">Moderado (ejercicio 3-5 días/semana)</option>
                                        <option value="1.725">Activo (ejercicio 6-7 días/semana)</option>
                                        <option value="1.9">Muy activo (ejercicio muy intenso)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="job-type">Tipo de trabajo</label>
                                <div class="select-wrapper">
                                    <select id="job-type" name="job-type">
                                        <option value="sedentary">Sedentario (oficina, teletrabajo)</option>
                                        <option value="light">Actividad ligera (comercio, docencia)</option>
                                        <option value="moderate">Actividad moderada (hostelería, mantenimiento)</option>
                                        <option value="heavy">Actividad física intensa (construcción, agricultura)</option>
                                        <option value="very-heavy">Actividad muy intensa (minería, deporte profesional)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="training-type">Tipo de entrenamiento</label>
                                    <div class="select-wrapper">
                                        <select id="training-type" name="training-type">
                                            <option value="none">No entreno regularmente</option>
                                            <option value="strength">Entrenamiento de fuerza</option>
                                            <option value="cardio">Cardio/Resistencia</option>
                                            <option value="mixed">Mixto (fuerza y cardio)</option>
                                            <option value="hiit">HIIT/Funcional</option>
                                            <option value="sports">Deporte específico</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="training-frequency">Horas semanales</label>
                                    <input type="number" id="training-frequency" name="training-frequency" min="0" max="30" placeholder="horas/semana">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Objetivos y preferencias</h3>
                            <div class="form-group">
                                <label for="goal">Objetivo principal</label>
                                <div class="goal-options">
                                    <label class="goal-option">
                                        <input type="radio" name="goal" value="lose-fast">
                                        <span class="goal-icon">🔥</span>
                                        <span class="goal-text">Pérdida rápida</span>
                                    </label>
                                    <label class="goal-option">
                                        <input type="radio" name="goal" value="lose">
                                        <span class="goal-icon">📉</span>
                                        <span class="goal-text">Pérdida moderada</span>
                                    </label>
                                    <label class="goal-option">
                                        <input type="radio" name="goal" value="maintain" checked>
                                        <span class="goal-icon">⚖️</span>
                                        <span class="goal-text">Mantenimiento</span>
                                    </label>
                                    <label class="goal-option">
                                        <input type="radio" name="goal" value="gain-mild">
                                        <span class="goal-icon">💪</span>
                                        <span class="goal-text">Ganancia suave</span>
                                    </label>
                                    <label class="goal-option">
                                        <input type="radio" name="goal" value="gain">
                                        <span class="goal-icon">📈</span>
                                        <span class="goal-text">Ganancia muscular</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="diet-type">Preferencia alimentaria</label>
                                <div class="select-wrapper">
                                    <select id="diet-type" name="diet-type">
                                        <option value="standard">Sin restricciones específicas</option>
                                        <option value="vegetarian">Vegetariano</option>
                                        <option value="vegan">Vegano</option>
                                        <option value="keto">Cetogénico</option>
                                        <option value="low-carb">Bajo en carbohidratos</option>
                                        <option value="mediterranean">Mediterránea</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="meals-per-day">Comidas diarias</label>
                                <div class="select-wrapper">
                                    <select id="meals-per-day" name="meals-per-day">
                                        <option value="3">3 comidas (desayuno, comida, cena)</option>
                                        <option value="4">4 comidas (incluye merienda)</option>
                                        <option value="5">5 comidas (con snacks)</option>
                                        <option value="if16">Ayuno intermitente 16/8</option>
                                        <option value="if20">Ayuno intermitente 20/4</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="calculate-button" class="button button-primary button-block">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14"></path>
                                <path d="M12 5v14"></path>
                            </svg>
                            Calcular mi plan nutricional personalizado
                        </button>
                    </div>
                </form>
            </div>

            <!-- Resultados -->
            <div class="card premium-card" id="results-card" style="display: none;">
                <div class="card-header">
                    <h2>Tus Resultados Personalizados</h2>
                    <span class="card-badge">Premium</span>
                </div>
                
                <div class="results-summary">
                    <div class="result-card">
                        <div class="result-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                        </div>
                        <div class="result-content">
                            <h4>Metabolismo Basal (TMB)</h4>
                            <div class="result-value"><span id="bmr-value">0</span> kcal</div>
                            <div class="result-description">Calorías que tu cuerpo quema en reposo</div>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="20" x2="12" y2="10"></line>
                                <line x1="18" y1="20" x2="18" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="16"></line>
                            </svg>
                        </div>
                        <div class="result-content">
                            <h4>Mantenimiento</h4>
                            <div class="result-value"><span id="maintenance-value">0</span> kcal</div>
                            <div class="result-description">Calorías para mantener tu peso actual</div>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-icon goal-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="result-content">
                            <h4>Para tu objetivo</h4>
                            <div class="result-value"><span id="goal-value">0</span> kcal</div>
                            <div class="result-description">Consumo diario recomendado</div>
                        </div>
                    </div>
                </div>
                
                <div class="macros-section">
                    <h3>Distribución de Macronutrientes</h3>
                    <div class="macro-details-grid">
                        <div class="macro-detail-card protein">
                            <div class="macro-detail-header">
                                <div class="macro-icon">P</div>
                                <h4>Proteínas</h4>
                            </div>
                            <div class="macro-value"><span id="protein-grams">0</span>g</div>
                            <div class="macro-percent"><span id="protein-percent">30</span>%</div>
                            <div class="macro-bar-container">
                                <div id="protein-bar" class="macro-bar protein" style="width: 30%;"></div>
                            </div>
                        </div>
                        
                        <div class="macro-detail-card carbs">
                            <div class="macro-detail-header">
                                <div class="macro-icon">C</div>
                                <h4>Carbohidratos</h4>
                            </div>
                            <div class="macro-value"><span id="carbs-grams">0</span>g</div>
                            <div class="macro-percent"><span id="carbs-percent">40</span>%</div>
                            <div class="macro-bar-container">
                                <div id="carbs-bar" class="macro-bar carbs" style="width: 40%;"></div>
                            </div>
                        </div>
                        
                        <div class="macro-detail-card fat">
                            <div class="macro-detail-header">
                                <div class="macro-icon">G</div>
                                <h4>Grasas</h4>
                            </div>
                            <div class="macro-value"><span id="fat-grams">0</span>g</div>
                            <div class="macro-percent"><span id="fat-percent">30</span>%</div>
                            <div class="macro-bar-container">
                                <div id="fat-bar" class="macro-bar fat" style="width: 30%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="button-row">
                    <button id="recalculate-button" class="button button-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                            <path d="M3 3v5h5"></path>
                            <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                            <path d="M16 21h5v-5"></path>
                        </svg>
                        Recalcular
                    </button>
                    <button id="save-button" class="button button-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Guardar Resultados
                    </button>
                </div>
            </div>
            
            <!-- Historial de cálculos -->
            <div class="card" id="history-card" style="display: none;">
                <div class="card-header">
                    <h2>Historial de Cálculos</h2>
                    <button id="clear-history-button" class="button button-danger button-small">Borrar historial</button>
                </div>
                <div id="history-list" class="history-list">
                    <!-- Aquí se agregarán los elementos del historial -->
                </div>
            </div>
            
            <!-- Panel de seguimiento de alimentos -->
            <div class="card" id="tracking-panel" style="display: none;">
                <div class="card-header fitness-header">
                    <h2>Tu Nutrición Fitness</h2>
                    <div class="header-actions">
                        <button id="returnToCalculatorBtn" class="button button-secondary button-small">
                            <span class="material-symbols-rounded">calculate</span> Calculadora
                        </button>
                        <div class="goal-indicator">
                            <span id="goalStatus" class="goal-badge">Sin objetivos</span>
                            <span id="kcalTotal">0</span> / <span id="kcalGoal">--</span> kcal
                        </div>
                    </div>
                </div>
                
                <div class="fitness-summary">
                    <div class="fitness-goal-visual">
                        <div class="goal-progress-container">
                            <svg class="goal-progress-ring" viewBox="0 0 160 160">
                                <circle class="progress-ring-circle-bg" cx="80" cy="80" r="70"></circle>
                                <circle id="mainGoalRing" class="progress-ring-circle" cx="80" cy="80" r="70" stroke-dasharray="439.822" stroke-dashoffset="439.822"></circle>
                                <text x="80" y="70" text-anchor="middle" dominant-baseline="middle" class="goal-text">Objetivo</text>
                                <text x="80" y="90" text-anchor="middle" dominant-baseline="middle" class="goal-value"><span id="kcalPercentage">0</span>%</text>
                                <text x="80" y="110" text-anchor="middle" dominant-baseline="middle" class="goal-type" id="goalTypeText">volumen</text>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="macro-summary">
                        <div class="macro-item protein-item">
                            <div class="macro-icon">P</div>
                            <div class="macro-data">
                                <span id="proteinTotal">0</span>g
                                <div class="macro-progress-bar">
                                    <div id="proteinProgressBar" class="progress-fill protein" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="macro-item carbs-item">
                            <div class="macro-icon">C</div>
                            <div class="macro-data">
                                <span id="carbTotal">0</span>g
                                <div class="macro-progress-bar">
                                    <div id="carbProgressBar" class="progress-fill carbs" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="macro-item fat-item">
                            <div class="macro-icon">G</div>
                            <div class="macro-data">
                                <span id="fatTotal">0</span>g
                                <div class="macro-progress-bar">
                                    <div id="fatProgressBar" class="progress-fill fat" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="add-food-btn-container">
                    <button id="add-food-button" class="button button-primary button-xl add-food-main-btn">
                        <span class="material-symbols-rounded">add_a_photo</span>
                        Añadir comida con foto
                    </button>
                    <div class="quick-options">
                        <button id="add-favorites-button" class="button button-secondary quick-option-btn">
                            <span class="material-symbols-rounded">favorite</span>
                        </button>
                        <button id="add-manual-button" class="button button-secondary quick-option-btn">
                            <span class="material-symbols-rounded">edit</span>
                        </button>
                        <button id="add-barcode-button" class="button button-secondary quick-option-btn">
                            <span class="material-symbols-rounded">qr_code_scanner</span>
                        </button>
                    </div>
                </div>
                
                <div class="entries-container">
                    <h3>Alimentos del día</h3>
                    <ul id="entriesList" class="entries-list">
                        <li class="no-entries">No has añadido ninguna comida hoy.</li>
                    </ul>
                </div>
            </div>
            
            <!-- Pestañas para añadir alimentos -->
            <div class="card" id="food-tabs" style="display: none;">
                <div class="card-header">
                    <h2>Añadir alimento</h2>
                    <button id="close-food-tabs" class="button button-icon button-tertiary">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                
                <div class="tabs">
                    <button class="tab-button" data-tab="photo">Foto</button>
                    <button class="tab-button" data-tab="favorites">Favoritos</button>
                    <button class="tab-button" data-tab="search">Buscar</button>
                    <button class="tab-button" data-tab="scan">Escanear</button>
                    <button class="tab-button" data-tab="quick">Manual</button>
                </div>
                
                <!-- Tab de foto con IA -->
                <div id="photo" class="tab-content">
                    <div id="uploadZone" class="upload-zone">
                        <span class="material-symbols-rounded">photo_camera</span>
                        <p>Haz clic o arrastra una foto de tu comida</p>
                        <input type="file" id="foodPhotoInput" accept="image/*" hidden>
                    </div>
                    
                    <div id="photoPreview" class="photo-preview" style="display: none;">
                        <img id="previewImage" src="" alt="Previsualización de comida">
                        <div class="photo-actions">
                            <button id="retakePhoto" class="button button-secondary">Cambiar foto</button>
                            <button id="analyzePhoto" class="button button-primary">Analizar con IA</button>
                        </div>
                    </div>
                </div>
                
                <!-- Tab de favoritos -->
                <div id="favorites" class="tab-content">
                    <div class="favorites-header">
                        <h3>Tus alimentos guardados</h3>
                        <div class="search-bar">
                            <input type="text" id="favoritesSearch" placeholder="Buscar en favoritos...">
                        </div>
                    </div>
                    
                    <div class="favorites-categories">
                        <button class="category-btn active" data-category="all">Todos</button>
                        <button class="category-btn" data-category="breakfast">Desayuno</button>
                        <button class="category-btn" data-category="lunch">Comida</button>
                        <button class="category-btn" data-category="dinner">Cena</button>
                        <button class="category-btn" data-category="snack">Snacks</button>
                    </div>
                    
                    <div id="favoritesList" class="favorites-grid">
                        <div class="empty-favorites">
                            <p>Aún no tienes favoritos guardados</p>
                            <p>Guarda alimentos que consumas habitualmente para acceder rápidamente</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab de búsqueda -->
                <div id="search" class="tab-content">
                    <div class="search-container">
                        <div class="form-group">
                            <label for="foodSearchInput">Busca alimentos en nuestra base de datos</label>
                            <input type="text" id="foodSearchInput" placeholder="Escribe para buscar...">
                        </div>
                        <div id="searchResults" class="search-results"></div>
                        <div id="searchDetails" class="search-details hidden">
                            <button id="backToSearch" class="button button-tertiary button-small">
                                <span class="material-symbols-rounded">arrow_back</span> Volver
                            </button>
                            <h3 id="selectedFoodName">Alimento</h3>
                            
                            <div class="quantity-selector">
                                <label for="foodQuantity">Cantidad (g)</label>
                                <div class="quantity-input-group">
                                    <button class="quantity-btn" data-action="decrease">-</button>
                                    <input type="number" id="foodQuantity" value="100" min="10" step="10">
                                    <button class="quantity-btn" data-action="increase">+</button>
                                </div>
                            </div>
                            
                            <div class="nutrition-preview">
                                <div class="nutrition-item">
                                    <span class="nutrition-value" id="previewKcal">0</span>
                                    <span class="nutrition-label">kcal</span>
                                </div>
                                <div class="nutrition-item">
                                    <span class="nutrition-value" id="previewProtein">0g</span>
                                    <span class="nutrition-label">Proteínas</span>
                                </div>
                                <div class="nutrition-item">
                                    <span class="nutrition-value" id="previewCarb">0g</span>
                                    <span class="nutrition-label">Carbos</span>
                                </div>
                                <div class="nutrition-item">
                                    <span class="nutrition-value" id="previewFat">0g</span>
                                    <span class="nutrition-label">Grasas</span>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button id="addToFavoritesBtn" class="button button-secondary">
                                    <span class="material-symbols-rounded">star</span> Guardar
                                </button>
                                <button id="addSearchedFood" class="button button-primary">Añadir a mi diario</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab de escaneo -->
                <div id="scan" class="tab-content">
                    <div class="barcode-container">
                        <div id="scannerPlaceholder" class="scanner-placeholder">
                            <span class="material-symbols-rounded">qr_code_scanner</span>
                            <p>Escanea el código de barras de un producto</p>
                            <button id="startScanButton" class="button button-primary">Iniciar escáner</button>
                        </div>
                        <div id="scannerView" class="scanner-view" style="display: none;">
                            <video id="scanner" width="100%"></video>
                            <div class="scanner-overlay">
                                <div class="scan-region"></div>
                            </div>
                        </div>
                    </div>
                    <div id="scanResults" class="scan-results" style="display: none;">
                        <h3 id="scannedProductName">Producto</h3>
                        <div class="scanned-nutrition">
                            <!-- Se llenará dinámicamente -->
                        </div>
                        <div class="action-buttons">
                            <button id="rescanButton" class="button button-secondary">Escanear otro</button>
                            <button id="addScannedFood" class="button button-primary">Añadir a mi diario</button>
                        </div>
                    </div>
                </div>
                
                <!-- Tab de añadir rápido -->
                <div id="quick" class="tab-content">
                    <div class="quick-add-form">
                        <div class="form-group">
                            <label for="quickFoodInput">¿Qué has comido?</label>
                            <input type="text" id="quickFoodInput" placeholder="Ejemplo: manzana, pollo asado, yogur..." autofocus>
                        </div>
                        
                        <div class="portion-area">
                            <label>¿Qué cantidad?</label>
                            <div class="portion-selector">
                                <button class="portion-btn" data-size="small">Pequeña</button>
                                <button class="portion-btn active" data-size="normal">Media</button>
                                <button class="portion-btn" data-size="large">Grande</button>
                            </div>
                        </div>
                        
                        <button id="addQuickFood" class="button button-primary button-block">Añadir a mi diario</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Módulos JS -->
    <script type="module" src="js/main.js"></script>
    
    <!-- Modal de objetivos -->
    <div id="goalModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configurar Objetivos</h2>
                <button id="closeGoalModal" class="button button-icon button-tertiary">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Indicador de carga para el cálculo con IA -->
                <div id="calculationLoadingIndicator" class="modal-loading" style="display: none;">
                    <div class="modal-loading-spinner"></div>
                    <p>Calculando objetivos personalizados con IA...</p>
                    <small>Analizando tus datos para recomendaciones precisas</small>
                </div>
            
                <h3>Datos personales</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userAge">Edad</label>
                        <input type="number" id="userAge" placeholder="Años" min="15" max="100">
                    </div>
                    <div class="form-group">
                        <label for="userSex">Sexo</label>
                        <div class="select-wrapper">
                            <select id="userSex">
                                <option value="male">Masculino</option>
                                <option value="female">Femenino</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="userWeight">Peso</label>
                        <input type="number" id="userWeight" placeholder="kg" min="30" max="300" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="userHeight">Altura</label>
                        <input type="number" id="userHeight" placeholder="cm" min="100" max="250">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="userActivityLevel">Nivel de actividad</label>
                    <div class="select-wrapper">
                        <select id="userActivityLevel">
                            <option value="1.2">Sedentario (poco o nada de ejercicio)</option>
                            <option value="1.375">Ligero (ejercicio 1-3 días/semana)</option>
                            <option value="1.55">Moderado (ejercicio 3-5 días/semana)</option>
                            <option value="1.725">Activo (ejercicio 6-7 días/semana)</option>
                            <option value="1.9">Muy activo (ejercicio muy intenso)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="userGoal">Objetivo</label>
                    <div class="select-wrapper">
                        <select id="userGoal">
                            <option value="0">Mantener peso</option>
                            <option value="-500">Pérdida moderada (-0.5kg/semana)</option>
                            <option value="-300">Pérdida suave (-0.3kg/semana)</option>
                            <option value="300">Ganancia suave (+0.3kg/semana)</option>
                            <option value="500">Ganancia moderada (+0.5kg/semana)</option>
                        </select>
                    </div>
                </div>
                
                <h3>Objetivos de macronutrientes</h3>
                
                <div class="form-group">
                    <label for="goalKcal">Calorías diarias</label>
                    <input type="number" id="goalKcal" placeholder="kcal" min="1000" max="5000">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="goalProtein">Proteínas (g)</label>
                        <input type="number" id="goalProtein" placeholder="g" min="30" max="300">
                    </div>
                    <div class="form-group">
                        <label for="goalCarb">Carbohidratos (g)</label>
                        <input type="number" id="goalCarb" placeholder="g" min="30" max="600">
                    </div>
                    <div class="form-group">
                        <label for="goalFat">Grasas (g)</label>
                        <input type="number" id="goalFat" placeholder="g" min="20" max="200">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="calculateGoalsButton" class="button button-secondary">Calcular objetivos</button>
                <button id="saveGoalsButton" class="button button-primary">Guardar objetivos</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de análisis con IA -->
    <div id="aiAnalysisModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header fitness-header">
                <h2>Análisis de Comida</h2>
                <button id="closeAnalysisModal" class="button button-icon button-tertiary">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="aiLoadingIndicator" class="modal-loading">
                    <div class="modal-loading-spinner"></div>
                    <p>Analizando tu comida con IA...</p>
                    <small>Identificando ingredientes y calculando macronutrientes</small>
                </div>
                
                <div id="aiResultContent" style="display: none;">
                    <div class="ai-result-image-container">
                        <div class="ai-result-image">
                            <img id="aiAnalyzedImage" src="" alt="Imagen analizada">
                            <div class="ai-labels">
                                <!-- Etiquetas generadas por IA -->
                            </div>
                        </div>
                        <div class="ai-confidence-indicator">
                            <span class="ai-confidence-text">Precisión de detección: Alta</span>
                            <div class="ai-confidence-bar">
                                <div class="ai-confidence-fill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-section">
                        <h3>Nutrición Total</h3>
                        <div class="nutrition-summary">
                            <div class="nutrition-item">
                                <span class="nutrition-value" id="aiKcal">0</span>
                                <span class="nutrition-label">kcal</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-value" id="aiProtein">0g</span>
                                <span class="nutrition-label">Proteínas</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-value" id="aiCarb">0g</span>
                                <span class="nutrition-label">Carbos</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-value" id="aiFat">0g</span>
                                <span class="nutrition-label">Grasas</span>
                            </div>
                        </div>
                    </div>
                    
                    <h3>Alimentos detectados</h3>
                    <ul id="detectedFoodsList" class="detected-foods-list">
                        <!-- Los alimentos detectados se mostrarán aquí -->
                    </ul>
                    
                    <div class="ai-tip">
                        <span class="material-symbols-rounded">lightbulb</span>
                        <p>Comida ideal para: <strong id="mealPurpose">Ganancia muscular</strong></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="adjustAiButton" class="button button-secondary">
                    <span class="material-symbols-rounded">edit</span> Ajustar ingredientes
                </button>
                <button id="saveToFavoritesAI" class="button button-secondary">
                    <span class="material-symbols-rounded">star</span> Guardar en favoritos
                </button>
                <button id="confirmAiButton" class="button button-primary">Añadir a mi diario</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de opciones de comida -->
    <div id="mealOptionsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="mealTypeHeader">Elige tu comida</h2>
                <button id="closeMealModal" class="button button-icon button-tertiary">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="commonMealsGrid" class="common-meals-grid">
                    <!-- Las opciones de comida se mostrarán aquí -->
                </div>
                
                <div class="custom-meal-option">
                    <button id="customMealButton" class="button button-secondary button-block">
                        <span class="material-symbols-rounded">add</span>
                        Crear entrada personalizada
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script de depuración y corrección -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Verificando elementos críticos:');
        
        // Verificar formulario y botones
        const formulario = document.getElementById('calculator-form');
        const botonCalcular = document.getElementById('calculate-button');
        const cardResultados = document.getElementById('results-card');
        
        console.log('Formulario:', formulario);
        console.log('Botón calcular:', botonCalcular);
        console.log('Tarjeta de resultados:', cardResultados);
        
        // Verificar modal y su contenido
        const modalObjetivos = document.getElementById('goalModal');
        const modalContent = modalObjetivos.querySelector('.modal-content');
        
        console.log('Modal de objetivos:', modalObjetivos);
        console.log('Contenido del modal:', modalContent);
        
        // Buscar y eliminar textos sueltos "Configurar Objetivos"
        // Primera forma: usando XPath
        const textosSueltos = document.evaluate(
            "//text()[normalize-space(.) = 'Configurar Objetivos' and not(ancestor::div[@id='goalModal'])]",
            document,
            null,
            XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
            null
        );
        
        console.log('Textos sueltos encontrados con XPath:', textosSueltos.snapshotLength);
        for (let i = 0; i < textosSueltos.snapshotLength; i++) {
            const nodo = textosSueltos.snapshotItem(i);
            console.log('Eliminando texto suelto:', nodo);
            if (nodo.parentNode) {
                nodo.parentNode.removeChild(nodo);
            }
        }
        
        // Segunda forma: usando recorrido DOM
        const body = document.body;
        const nodes = [];
        
        function findTextNodes(node) {
            if (node.nodeType === 3) { // Nodo de texto
                const text = node.textContent.trim();
                if (text === 'Configurar Objetivos' || text.includes('✕')) {
                    nodes.push(node);
                }
            } else if (node.nodeType === 1) { // Elemento
                // No buscar dentro de los modales
                if (!node.classList || !node.classList.contains('modal')) {
                    for (let i = 0; i < node.childNodes.length; i++) {
                        findTextNodes(node.childNodes[i]);
                    }
                }
            }
        }
        
        findTextNodes(body);
        console.log('Textos sueltos encontrados con DOM:', nodes.length);
        
        // Eliminar los nodos de texto encontrados
        nodes.forEach(node => {
            console.log('Eliminando nodo:', node);
            if (node.parentNode) {
                node.parentNode.removeChild(node);
            }
        });
        
        // Detectar elementos huérfanos o incorrectos
        const elementosConfigObjetivos = document.querySelectorAll('h2, button');
        elementosConfigObjetivos.forEach(elem => {
            if (elem.textContent.includes('Configurar Objetivos') && 
                !elem.closest('#goalModal')) {
                console.log('Elemento incorrecto encontrado:', elem);
                elem.style.display = 'none';
            }
        });
    });
    </script>
    
    <!-- Estilos para corregir el problema -->
    <style>
    /* Asegurar que el contenido del modal esté siempre dentro del modal */
    .modal-content {
        position: relative !important;
        margin: 10vh auto !important;
        transform: none !important;
        left: auto !important;
        bottom: auto !important;
        overflow: hidden;
    }
    
    /* Ocultar cualquier elemento de texto fuera del modal */
    body > h2, 
    body > button {
        display: none !important;
    }
    
    /* Arreglar el posicionamiento del texto "Configurar Objetivos" */
    h2:not([id]):not([class]):empty, 
    button:not([id]):not([class]):empty {
        display: none !important;
    }
    </style>
</body>
</html> 